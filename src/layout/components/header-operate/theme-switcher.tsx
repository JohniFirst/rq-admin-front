import { SettingOutlined } from '@ant-design/icons'
import { Dropdown, MenuProps, Switch, TimePicker, message } from 'antd'
import { motion } from 'framer-motion'
import { useEffect, useState, useRef } from 'react'
import styled from 'styled-components'
import { useAppDispatch, useAppSelector } from '@/store/hooks'
import { selectCurrentTheme, setTheme } from '@/store/slice/system-info'
import dayjs from 'dayjs'

type ThemeMode = 'light' | 'dark' | 'system' | 'auto'

interface AutoThemeConfig {
  enabled: boolean
  lightTime: string // HH:mm Ê†ºÂºè
  darkTime: string // HH:mm Ê†ºÂºè
}

// Styled Components
const ThemeButton = styled(motion.button)<{ $isDark: boolean }>`
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid var(--color-border);
  background: var(--color-surface);
  transition: all 0.3s ease;
  cursor: pointer;

  &:hover {
    border-color: var(--color-primary);
    background: var(--color-surface-hover);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .icon {
    font-size: 18px;
  }

  .text {
    font-size: 14px;
    font-weight: 500;
  }

  .setting-icon {
    font-size: 12px;
    opacity: 0.6;
  }
`

const DropdownContainer = styled.div<{ $isDark: boolean }>`
  .ant-dropdown-menu {
    min-width: 280px;
    padding: 8px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, ${props => (props.$isDark ? '0.3' : '0.1')});
    backdrop-filter: blur(10px);
    background: ${props => (props.$isDark ? 'var(--color-surface)' : 'var(--color-background)')};
    border: 1px solid var(--color-border);
  }

  .ant-dropdown-menu-item {
    border-radius: 8px;
    margin: 2px 0;
    padding: 8px 12px;
    transition: all 0.2s ease;
    color: var(--color-text);

    &:hover {
      background-color: var(--color-surface-hover);
    }
  }

  .ant-dropdown-menu-item-divider {
    margin: 8px 0;
    border-color: var(--color-border);
  }

  .ant-dropdown-menu-item-selected {
    background-color: var(--color-primary);
    color: var(--color-background);
  }
`

const MenuItem = styled.div`
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 256px;
`

const MenuItemContent = styled.span`
  display: flex;
  align-items: center;
  gap: 8px;
`

const CheckMark = styled.span`
  color: var(--color-primary);
  font-weight: bold;
`

const AutoSection = styled.div`
  display: flex;
  flex-direction: column;
  gap: 12px;
`

const AutoHeader = styled.div`
  display: flex;
  align-items: center;
  justify-content: space-between;
`

const TimeSettings = styled.div`
  padding-left: 24px;
  display: flex;
  flex-direction: column;
  gap: 8px;
`

const TimeRow = styled.div`
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 14px;
`

const ThemeSwitcher = () => {
  const currentTheme = useAppSelector(selectCurrentTheme)
  const dispatch = useAppDispatch()
  const [autoConfig, setAutoConfig] = useState<AutoThemeConfig>({
    enabled: false,
    lightTime: '06:00',
    darkTime: '18:00',
  })
  const [systemMode, setSystemMode] = useState<'light' | 'dark'>('light')
  const [currentMode, setCurrentMode] = useState<ThemeMode>('light')
  const timerRef = useRef<NodeJS.Timeout | null>(null)

  const isDark = currentTheme.isDark

  // ËÆ°ÁÆó‰∏ãÊ¨°‰∏ªÈ¢òÂàáÊç¢Êó∂Èó¥
  const getNextSwitchTime = () => {
    const now = dayjs()
    const lightTime = dayjs(autoConfig.lightTime, 'HH:mm')
    const darkTime = dayjs(autoConfig.darkTime, 'HH:mm')

    // ËÆæÁΩÆ‰ªäÂ§©ÁöÑÂàáÊç¢Êó∂Èó¥
    const todayLightTime = dayjs().hour(lightTime.hour()).minute(lightTime.minute()).second(0)
    const todayDarkTime = dayjs().hour(darkTime.hour()).minute(darkTime.minute()).second(0)

    // Âà§Êñ≠ÂΩìÂâçÂ∫îËØ•ÊòØ‰ªÄ‰πà‰∏ªÈ¢ò
    let shouldBeLight = false
    let nextSwitchTime: dayjs.Dayjs

    if (lightTime.isBefore(darkTime)) {
      // Âêå‰∏ÄÂ§©ÂÜÖÔºö06:00 - 18:00 ‰∏∫ÊµÖËâ≤
      shouldBeLight = now.isAfter(todayLightTime) && now.isBefore(todayDarkTime)
      nextSwitchTime = shouldBeLight ? todayDarkTime : todayLightTime
    } else {
      // Ë∑®Â§©Ôºö18:00 - 06:00 ‰∏∫Ê∑±Ëâ≤
      shouldBeLight = now.isAfter(todayLightTime) || now.isBefore(todayDarkTime)
      nextSwitchTime = shouldBeLight ? todayDarkTime : todayLightTime
    }

    // Â¶ÇÊûú‰∏ãÊ¨°ÂàáÊç¢Êó∂Èó¥Â∑≤ÁªèËøá‰∫ÜÔºåËÆæÁΩÆ‰∏∫ÊòéÂ§©
    if (nextSwitchTime.isBefore(now)) {
      nextSwitchTime = nextSwitchTime.add(1, 'day')
    }

    return { shouldBeLight, nextSwitchTime }
  }

  // ËÆæÁΩÆËá™Âä®‰∏ªÈ¢òÂàáÊç¢ÂÆöÊó∂Âô®
  const setupAutoThemeTimer = () => {
    // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
    if (timerRef.current) {
      clearTimeout(timerRef.current)
    }

    if (!autoConfig.enabled) return

    const { shouldBeLight, nextSwitchTime } = getNextSwitchTime()
    const targetTheme = shouldBeLight ? 'default-light' : 'purple-dark'

    // Á´ãÂç≥Â∫îÁî®ÂΩìÂâçÂ∫îËØ•ÁöÑ‰∏ªÈ¢ò
    if (currentTheme.id !== targetTheme) {
      dispatch(setTheme(targetTheme))
    }

    // ËÆ°ÁÆóÂà∞‰∏ãÊ¨°ÂàáÊç¢ÁöÑÊØ´ÁßíÊï∞
    const delay = nextSwitchTime.diff(dayjs())

    // ËÆæÁΩÆ‰∏ÄÊ¨°ÊÄßÂÆöÊó∂Âô®
    timerRef.current = setTimeout(() => {
      // ÂàáÊç¢‰∏ªÈ¢ò
      const newTheme = targetTheme === 'default-light' ? 'purple-dark' : 'default-light'
      dispatch(setTheme(newTheme))

      // ÈÄíÂΩíËÆæÁΩÆ‰∏ãÊ¨°ÂàáÊç¢
      setupAutoThemeTimer()
    }, delay)
  }

  // ÁõëÂê¨Á≥ªÁªü‰∏ªÈ¢òÂèòÂåñ
  useEffect(() => {
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)')

    const handleSystemThemeChange = (e: MediaQueryListEvent) => {
      const newSystemMode = e.matches ? 'dark' : 'light'
      setSystemMode(newSystemMode)

      // Â¶ÇÊûúÂΩìÂâçÊòØË∑üÈöèÁ≥ªÁªüÊ®°ÂºèÔºåÂàôÁ´ãÂç≥ÂàáÊç¢‰∏ªÈ¢ò
      if (currentMode === 'system') {
        const systemTheme = newSystemMode === 'dark' ? 'purple-dark' : 'default-light'
        dispatch(setTheme(systemTheme))
      }
    }

    // ÂàùÂßãÂåñÁ≥ªÁªü‰∏ªÈ¢ò
    setSystemMode(mediaQuery.matches ? 'dark' : 'light')

    // ÁõëÂê¨Á≥ªÁªü‰∏ªÈ¢òÂèòÂåñ
    mediaQuery.addEventListener('change', handleSystemThemeChange)

    return () => mediaQuery.removeEventListener('change', handleSystemThemeChange)
  }, [dispatch, currentMode])

  // Ëá™Âä®‰∏ªÈ¢òÂàáÊç¢ÈÄªËæë
  useEffect(() => {
    setupAutoThemeTimer()

    // Ê∏ÖÁêÜÂÆöÊó∂Âô®
    return () => {
      if (timerRef.current) {
        clearTimeout(timerRef.current)
      }
    }
  }, [autoConfig.enabled, autoConfig.lightTime, autoConfig.darkTime, currentTheme.id, dispatch])

  // Ëé∑ÂèñÂΩìÂâç‰∏ªÈ¢òÊ®°Âºè
  const getCurrentThemeMode = (): ThemeMode => {
    if (autoConfig.enabled) return 'auto'
    if (currentTheme.id === 'purple-dark') return 'dark'
    if (currentTheme.id === 'default-light') return 'light'
    return 'system'
  }

  // Â§ÑÁêÜ‰∏ªÈ¢òÂàáÊç¢
  const handleThemeChange = (mode: ThemeMode) => {
    setCurrentMode(mode)

    switch (mode) {
      case 'light': {
        setAutoConfig(prev => ({ ...prev, enabled: false }))
        dispatch(setTheme('default-light'))
        break
      }
      case 'dark': {
        setAutoConfig(prev => ({ ...prev, enabled: false }))
        dispatch(setTheme('purple-dark'))
        break
      }
      case 'system': {
        setAutoConfig(prev => ({ ...prev, enabled: false }))
        // Ê†πÊçÆÂΩìÂâçÁ≥ªÁªü‰∏ªÈ¢òËÆæÁΩÆ
        const systemTheme = systemMode === 'dark' ? 'purple-dark' : 'default-light'
        dispatch(setTheme(systemTheme))
        break
      }
      case 'auto': {
        setAutoConfig(prev => ({ ...prev, enabled: true }))
        // Á´ãÂç≥ËÆæÁΩÆËá™Âä®ÂàáÊç¢
        setupAutoThemeTimer()
        break
      }
    }
  }

  // Â§ÑÁêÜËá™Âä®ÂàáÊç¢Êó∂Èó¥ËÆæÁΩÆ
  const handleAutoTimeChange = (type: 'light' | 'dark', time: dayjs.Dayjs | null) => {
    if (!time) return

    const timeStr = time.format('HH:mm')
    setAutoConfig(prev => ({
      ...prev,
      [type === 'light' ? 'lightTime' : 'darkTime']: timeStr,
    }))

    if (autoConfig.enabled) {
      // Â¶ÇÊûúËá™Âä®ÂàáÊç¢Â∑≤ÂêØÁî®ÔºåÈáçÊñ∞ËÆæÁΩÆÂÆöÊó∂Âô®
      setupAutoThemeTimer()
    }
  }

  // ÂàáÊç¢Ëá™Âä®Ê®°ÂºèÂºÄÂÖ≥
  const handleAutoToggle = (enabled: boolean) => {
    setAutoConfig(prev => ({ ...prev, enabled }))
    if (enabled) {
      setCurrentMode('auto')
      handleThemeChange('auto')
      message.success('Â∑≤ÂêØÁî®Ëá™Âä®‰∏ªÈ¢òÂàáÊç¢')
    } else {
      // Ê∏ÖÈô§ÂÆöÊó∂Âô®
      if (timerRef.current) {
        clearTimeout(timerRef.current)
        timerRef.current = null
      }
      message.info('Â∑≤ÂÖ≥Èó≠Ëá™Âä®‰∏ªÈ¢òÂàáÊç¢')
    }
  }

  // Ëé∑ÂèñÂΩìÂâç‰∏ªÈ¢òÂõæÊ†á
  const getThemeIcon = () => {
    const mode = getCurrentThemeMode()
    switch (mode) {
      case 'dark':
        return 'üåô'
      case 'light':
        return '‚òÄÔ∏è'
      case 'system':
        return 'üñ•Ô∏è'
      case 'auto':
        return '‚è∞'
      default:
        return isDark ? 'üåô' : '‚òÄÔ∏è'
    }
  }

  // Ëé∑ÂèñÂΩìÂâç‰∏ªÈ¢òÊñáÊú¨
  const getThemeText = () => {
    const mode = getCurrentThemeMode()
    switch (mode) {
      case 'dark':
        return 'Ê∑±Ëâ≤'
      case 'light':
        return 'ÊµÖËâ≤'
      case 'system':
        return 'Ë∑üÈöèÁ≥ªÁªü'
      case 'auto':
        return 'Ëá™Âä®ÂàáÊç¢'
      default:
        return isDark ? 'Ê∑±Ëâ≤' : 'ÊµÖËâ≤'
    }
  }

  const dropdownItems: MenuProps['items'] = [
    {
      key: 'light',
      label: (
        <MenuItem>
          <MenuItemContent>
            <span>‚òÄÔ∏è</span>
            <span>ÊµÖËâ≤‰∏ªÈ¢ò</span>
          </MenuItemContent>
          {getCurrentThemeMode() === 'light' && <CheckMark>‚úì</CheckMark>}
        </MenuItem>
      ),
      onClick: () => handleThemeChange('light'),
    },
    {
      key: 'dark',
      label: (
        <MenuItem>
          <MenuItemContent>
            <span>üåô</span>
            <span>Ê∑±Ëâ≤‰∏ªÈ¢ò</span>
          </MenuItemContent>
          {getCurrentThemeMode() === 'dark' && <CheckMark>‚úì</CheckMark>}
        </MenuItem>
      ),
      onClick: () => handleThemeChange('dark'),
    },
    {
      key: 'system',
      label: (
        <MenuItem>
          <MenuItemContent>
            <span>üñ•Ô∏è</span>
            <span>Ë∑üÈöèÁ≥ªÁªü</span>
          </MenuItemContent>
          {getCurrentThemeMode() === 'system' && <CheckMark>‚úì</CheckMark>}
        </MenuItem>
      ),
      onClick: () => handleThemeChange('system'),
    },
    {
      type: 'divider',
    },
    {
      key: 'auto',
      label: (
        <AutoSection>
          <AutoHeader>
            <MenuItemContent>
              <span>‚è∞</span>
              <span>Ëá™Âä®ÂàáÊç¢</span>
            </MenuItemContent>
            <div onClick={e => e.stopPropagation()}>
              <Switch size="small" checked={autoConfig.enabled} onChange={handleAutoToggle} />
            </div>
          </AutoHeader>
          {autoConfig.enabled && (
            <TimeSettings>
              <TimeRow>
                <span>ÊµÖËâ≤Êó∂Èó¥:</span>
                <div onClick={e => e.stopPropagation()}>
                  <TimePicker
                    size="small"
                    format="HH:mm"
                    value={dayjs(autoConfig.lightTime, 'HH:mm')}
                    onChange={time => handleAutoTimeChange('light', time)}
                  />
                </div>
              </TimeRow>
              <TimeRow>
                <span>Ê∑±Ëâ≤Êó∂Èó¥:</span>
                <div onClick={e => e.stopPropagation()}>
                  <TimePicker
                    size="small"
                    format="HH:mm"
                    value={dayjs(autoConfig.darkTime, 'HH:mm')}
                    onChange={time => handleAutoTimeChange('dark', time)}
                  />
                </div>
              </TimeRow>
            </TimeSettings>
          )}
        </AutoSection>
      ),
      onClick: () => {
        if (!autoConfig.enabled) {
          handleAutoToggle(true)
        }
      },
    },
  ]

  return (
    <DropdownContainer $isDark={isDark}>
      <Dropdown menu={{ items: dropdownItems }} placement="bottomRight" trigger={['click']}>
        <ThemeButton
          $isDark={isDark}
          whileHover={{ scale: 1.02 }}
          whileTap={{ scale: 0.98 }}
          aria-label="‰∏ªÈ¢òËÆæÁΩÆ"
        >
          <span className="icon">{getThemeIcon()}</span>
          <span className="text">{getThemeText()}</span>
          <SettingOutlined className="setting-icon" />
        </ThemeButton>
      </Dropdown>
    </DropdownContainer>
  )
}

export default ThemeSwitcher
